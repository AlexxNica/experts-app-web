<dom-module id="gde-app">

  <style>
    #drawerToolbar {
      color: var(--secondary-text-color);
      background-color: var(--drawer-menu-color);
      border-bottom: var(--drawer-toolbar-border-color);
      height: 64px;
    }

    paper-material {
      border-radius: 2px;
      height: 100%;
      padding: 16px 0 16px 0;
      width: calc(98.66% - 16px);
      margin: 16px auto;
      background: white;
    }

    paper-menu iron-icon {
      margin-right: 33px;
      opacity: 0.54;
    }

    .paper-menu > .iron-selected {
      color: var(--default-primary-color);
    }

    paper-menu a {
      text-decoration: none;
      color: var(--menu-link-color);
      display: -ms-flexbox;
      display: -webkit-flex;
      display: flex;
      -ms-flex-direction: row;
      -webkit-flex-direction: row;
      flex-direction: row;
      -ms-flex-align: center;
      -webkit-align-items: center;
      align-items: center;
      font-family: 'Roboto', 'Noto', sans-serif;
      -webkit-font-smoothing: antialiased;
      text-rendering: optimizeLegibility;
      font-size: 14px;
      font-weight: 400;
      line-height: 24px;
      min-height: 48px;
      padding: 0 16px;
    }

    #mainToolbar .middle {
      margin-left: 48px;
    }

    #mainToolbar.has-shadow .middle {
      font-size: 20px;
      padding-bottom: 0;
      margin-left: 48px;
    }

    #mainToolbar.has-shadow #user > span {
      display: none;
    }

    #mainToolbar.has-shadow google-signin {
      display: none;
    }

    #user {
      @apply(--layout-horizontal);
      @apply(--layout-center);
    }

    #user img {
      height: 40px;
      width: 40px;
      margin-left: 10px;
      margin-right: 10px;
      border-radius: 50%;
    }



    /* Breakpoints */

    /* Small */
    @media (max-width: 600px) {

      paper-material {
        --menu-container-display: none;
        width: calc(97.33% - 32px);
        padding-left: 16px;
        padding-right: 16px;
      }

      .paper-font-display1 {
        font-size: 12px;
      }

      .app-name {
        font-size: 26px;
      }

      #drawer .paper-toolbar {
        margin-left: 16px;
      }

      #overlay {
        min-width: 360px;
      }

      .bg {
        background: white;
      }

    }

    /* Tablet+ */
    @media (min-width: 601px) {

      paper-material {
        width: calc(98% - 46px);
        margin-bottom: 32px;
        padding-left: 30px;
        padding-right: 30px;
      }

      #drawer.paper-drawer-panel > [drawer] {
        border-right: 1px solid rgba(0, 0, 0, 0.14);
      }

      iron-pages {
        padding: 48px 62px;
      }

    }

    /* Material Design Adaptive Breakpoints */
    /*
      Below you'll find CSS media queries based on the breakpoint guidance
      published by the Material Design team. You can choose to use, customise
      or remove these breakpoints based on your needs.

      http://www.google.com/design/spec/layout/adaptive-ui.html#adaptive-ui-breakpoints
     */

    /* mobile-small */
    @media all and (min-width: 0) and (max-width: 360px) and (orientation: portrait) { }
    /* mobile-large */
    @media all and (min-width: 361px) and (orientation: portrait) { }
    /* mobile-small-landscape */
    @media all and (min-width: 0) and (max-width: 480px) and (orientation: landscape) { }
    /* mobile-large-landscape */
    @media all and (min-width: 481px) and (orientation: landscape) { }
    /* tablet-small-landscape */
    @media all and (min-width: 600px) and (max-width: 960px) and (orientation: landscape) { }
    /* tablet-large-landscape */
    @media all and (min-width: 961px) and (orientation: landscape) { }
    /* tablet-small */
    @media all and (min-width: 600px) and (orientation: portrait) { }
    /* tablet-large */
    @media all and (min-width: 601px) and (max-width: 840px) and (orientation : portrait) { }
    /* desktop-x-small-landscape */
    @media all and (min-width: 0) and (max-width: 480px) and (orientation: landscape) { }
    /* desktop-x-small */
    @media all and (min-width: 0) and (max-width: 480px) and (max-aspect-ratio: 4/3) { }
    /* desktop-small-landscape */
    @media all and (min-width: 481px) and (max-width: 840px) and (orientation: landscape) { }
    /* desktop-small */
    @media all and (min-width: 481px) and (max-width: 840px) and (max-aspect-ratio: 4/3) { }
    /* desktop-medium-landscape */
    @media all and (min-width: 841px) and (max-width: 1280px) and (orientation: landscape) { }
    /* desktop-medium */
    @media all and (min-width: 841px) and (max-width: 1280px) and (max-aspect-ratio: 4/3) { }
    /* desktop-large */
    @media all and (min-width: 1281px) and (max-width: 1600px) { }
    /* desktop-xlarge */
    @media all and (min-width: 1601px) and (max-width: 1920px) { }
  </style>

  <template>

    <!-- Prepare elements to access the API -->
    <discovery-api-elements
      name="gdetracking"
      version="v1.0b2"
      app-id="omega-keep-406"
      ></discovery-api-elements>

    <!-- Fetch information about currently signed-in User -->
    <gdetracking-account-get
      id="[[user.id]]"
      auto$="[[isAuthorized]]"
      response="{{apiUser}}"></gdetracking-account-get>

    <paper-drawer-panel id="paperDrawerPanel">
      <div drawer>

        <!-- Drawer Toolbar -->
        <paper-toolbar id="drawerToolbar">
          <span class="paper-font-title">Menu</span>
        </paper-toolbar>

        <!-- Drawer Content -->
          <paper-menu class="list" attr-for-selected="data-route" selected="{{route}}" on-iron-select="onMenuSelect">
              <a data-route="home" href="/">
                <iron-icon icon="home"></iron-icon>
                <span>Home</span>
              </a>

              <template is="dom-if" if="[[isGoogler]]">
                <a data-route="general-statistics" href="/general-statistics">
                  <iron-icon icon="trending-up"></iron-icon>
                  <span>Googler Access</span>
                </a>
              </template>

              <template is="dom-if" if="[[isGde]]">
                <a data-route="my-statistics" href="/my-statistics">
                  <iron-icon icon="face"></iron-icon>
                  <span>GDE Access</span>
                </a>
              </template>

              <!-- To help during development -->
              <a data-route="api-docs" href="/api-docs">
                <iron-icon icon="settings"></iron-icon>
                <span>API Element Docs</span>
              </a>
          </paper-menu>
      </div>
      <paper-header-panel main mode="waterfall-tall">

        <!-- Main Toolbar -->
        <paper-toolbar id="mainToolbar">
          <paper-icon-button icon="menu" paper-drawer-toggle></paper-icon-button>
          <span class="flex"></span>

          <div hidden$="[[!isAuthorized]]" id="user">
            <span>[[user.name]]</span>
            <img src$="[[user.image]]">
          </div>

          <!-- Toolbar icons -->
          <google-signin
            client-id="47242318878-dik3r14d8jc528h1ao35f8ehqa7tmpe1.apps.googleusercontent.com"
            scope="email profile"
            is-authorized="{{isAuthorized}}"></google-signin>

          <!-- Application name -->
          <div class="middle paper-font-display2 app-name">GDE Tracking App</div>

          <!-- Application sub title -->
          <div class="bottom title"></div>

        </paper-toolbar>

        <!-- Main Content -->
        <div class="content">
          <iron-pages attr-for-selected="data-route" selected="{{route}}">

            <section data-route="home">
              <paper-material elevation="1" hidden$="[[!isGde]]">
                <p class="paper-font-body2">You are a GDE!</p>
              </paper-material>
              <paper-material elevation="1" hidden$="[[!isAdmin]]">
                <p class="paper-font-body2">You are an Admin!</p>
              </paper-material>
              <paper-material elevation="1" hidden$="[[!isGoogler]]">
                <p class="paper-font-body2">You are a Googler!</p>
              </paper-material>
            </section>

            <template is="dom-if" if="[[isGde]]">
              <section data-route="my-statistics">
                <!-- placeholder for element that will handle gde activities -->
                <paper-material elevation="1">
                  <p>GDE Area</p>
                  <activity-list user-id="[[user.id]]"></activity-list>
                </paper-material>
              </section>

              <section data-route="activity">
                Activity: <span>[[params.activityId]]</span>
              </section>
            </template>

            <template is="dom-if" if="[[isGoogler]]">
              <section data-route="general-statistics">
                <!-- placeholder for element that will handle statistics for Googlers -->
                <paper-material elevation="1">
                  <p>Googler Area</p>
                </paper-material>
              </section>
            </template>


            <section data-route="api-docs">
              <!-- To help during development -->
              <discovery-api-docs
                name="gdetracking"
                version="v1.0b2"
                app-id="omega-keep-406"></discovery-api-docs>
            </section>

          </iron-pages>
        </div>
      </paper-header-panel>
    </paper-drawer-panel>

    <paper-toast id="cachingComplete"
                 duration="6000"
                 text="Caching complete! This app will work offline.">
    </paper-toast>

    <platinum-sw-register auto-register
                          clients-claim
                          skip-waiting
                          on-service-worker-installed="displayInstalledToast">
      <platinum-sw-cache default-cache-strategy="networkFirst"
                         precache-file="precache.json">
      </platinum-sw-cache>
    </platinum-sw-register>
  </template>

  <script>
    (function() {
      Polymer({
        is: 'gde-app',
        properties: {
          user: {
            type: Object,
            computed: '_computeUser(isAuthorized)'
          },
          isGde: {
            type: Boolean,
            computed: '_isGde(apiUser.type, isAuthorized)',
            value: false
          },
          isAdmin: {
            type: Boolean,
            computed: '_isAdmin(apiUser.type, isAuthorized)',
            value: false
          },
          isGoogler: {
            type: Boolean,
            computed: '_isGoogler(user.email, isAdmin, isAuthorized)',
            value: false
          }
        },
        displayInstalledToast: function () {
          this.$.cachingComplete.show();
        },
        onMenuSelect: function () {
          var drawerPanel = this.$.paperDrawerPanel;
          if (drawerPanel.narrow) {
            drawerPanel.closeDrawer();
          }
        },
        _computeUser: function (isAuthorized) {
          if (!isAuthorized) { return undefined; }
          var profile = gapi.auth2.getAuthInstance()
                          .currentUser.get().getBasicProfile();
          return {
            id: profile.getId(),
            name: profile.getName(),
            image: profile.getImageUrl(),
            email: profile.getEmail()
          };
        },
        _isGde: function (type , isAuthorized) {
          if (!isAuthorized) { return false; }
          return (type === 'active');
        },
        _isAdmin: function (type , isAuthorized) {
          if (!isAuthorized) { return false; }
          return (type === 'administrator' || type === 'manager');
        },
        _isGoogler: function (email, isAdmin, isAuthorized) {
          if (!isAuthorized) { return false; }
          if (isAdmin) { return true; }
          return (email.split('@')[1] === 'google.com');
        }
      });
    })();
  </script>
</dom-module>
