<!--
    Google Developers Experts Tracking App
    Copyright (C) 2016  by the GDE Tracking App Team
    
    gdetracking.appspot.com/
    https://github.com/GoogleDeveloperExperts/experts-app-web

    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with this program.  If not, see <http://www.gnu.org/licenses/>
-->
<link rel="import" href="../bower_components/polymer/polymer.html">

<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">

<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-header-panel/paper-header-panel.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-material/paper-material.html">
<link rel="import" href="../bower_components/paper-toolbar/paper-toolbar.html">

<link rel="import" href="../bower_components/discovery-api-elements/discovery-api-elements.html">
<!--  
    ====================================
                  Shady DOM  
    ====================================
-->
<dom-module id="gtt-profile">
  <template>
<!--
    ====================================
                     CSS 
    ====================================
-->
    <style>
      :host {
        display           : block;
        height            : 100%;
        font-family       : Roboto;
        
        --paper-toolbar-background  : #ff2179;
        --paper-toolbar-tall        : {
          height            : 240px
        };
      }
      [hidden] {
        display           : none !important;
      }
      paper-header-panel {
        --paper-header-panel-body  : {
          background-color  : #eee;
        }
      }
      paper-header-panel h1 {
        font-size         : 24px;
        font-weight       : 300;
        position          : absolute;
        top               : 84px;
        left              : 15vw;
        margin            : 0;
      }
      paper-button  {
        position          : absolute;
        top               : 80px;
        right             : 15vw;
        width             : 116px;
        margin            : 0;
        height            : 40px;
        color             : #ff2179;
        background-color  : #fff;
        transition        : box-shadow 0.3s cubic-bezier(.25,.8,.25,1);
        box-shadow        : 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
      }
      paper-button:hover {
        box-shadow        : 0 3px 6px rgba(0,0,0,0.16), 0 3px 6px rgba(0,0,0,0.23);
      }
      paper-material {
        display           : flex;
        flex-direction    : row;
        background        : white;
        box-sizing        : border-box;
        width             : 70vw;
        min-height        : 70vh;
        padding           : 48px 103px 48px 48px;
        border-radius     : 2px;
        margin            : 128px 15vw 17px;
        transition        : box-shadow 0.3s cubic-bezier(.25,.8,.25,1);
        box-shadow        : 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
      }
      paper-material:hover {
        box-shadow        : 0 3px 6px rgba(0,0,0,0.16), 0 3px 6px rgba(0,0,0,0.23);
      }
      user-avatar {
        display           : block;
        padding-right     : 24px;
      }
      user-avatar  img {
        border-radius     : 50%;
        background-color  : #eee;
        height            : 80px;
        width             : 80px;
      }
      user-info {
        flex              : 4;
        color             : #282828;
      }
      user-info  h2 {
        font-size         : 24px;
        margin            : 0;
        font-weight       : 300;
      }
      user-info  p {
        font-size         : 14px;
        margin            : 8px 0;
        font-weight       : 300;
      }
      user-info  .line {
        width             : 192px;
        height            : 1px;
        background-color  : #282828;
        margin            : 23px 0;
      }
      user-info .biography {
        white-space       : pre-line;
      }     
      iron-icon.edit {
        cursor: pointer;
        margin-left: 15px;
        color: var(--google-blue-500);;
      }      
      iron-icon.submit  {
        cursor: pointer;
        margin-left: 15px;
        color: var(--google-green-500);
      }
      iron-icon.close {
        color: var(--google-red-500);
      }
      
      iron-icon[disabled] {
        color: var(--google-grey-500) !important;
      }

      user-info .item_value {
        font-size         : 14px;
        font-weight       : 300;
        @apply(--layout-horizontal);
        @apply(--layout-center);
      }     
      user-info .item_value paper-input,
      user-info .item_value span {
        margin-right: 15px;
      }       
    </style>
<!--  
    ====================================
                   HTML
    ====================================
-->



    <!-- Prepare elements to access the API -->
    <discovery-api-elements
      name="expertstracking"
      version="v2.0"
      app-id="elite-firefly-737"
      no-client
      ></discovery-api-elements>

    <!-- Fetch information about currently signed-in User -->
    <expertstracking-account-get
      id="[[user.email]]"
      response="{{_apiUser}}"
      on-success="_handleAccountGet"
      auto$="{{user}}"></expertstracking-account-get>      
      <!--  client-id="47242318878-dik3r14d8jc528h1ao35f8ehqa7tmpe1.apps.googleusercontent.com" 
      -->

    <expertstracking-account-insert 
      id="[[user.email]]"
      on-success="_handleUserInserted"></expertstracking-account-get>   

    <paper-header-panel 
      mode = "cover">
      <paper-toolbar 
        class = "tall">
        <h1>My profile - {{_apiUser.email}}</h1>
        <paper-button>
          Edit
        </paper-button>
      </paper-toolbar>
      <paper-material>
        <user-avatar>
          <img 
            alt = "Avatar"
            src = "{{user.image}}"/>
        </user-avatar>
        <user-info>
          <h2>{{user.name}}</h2>
          <p>{{_userTitle}}</p>
          <div class="item_value">
            <template is="dom-if" if="{{!_isEditingLocation}}">
              <template is="dom-if" if="{{user.city}}">
                <span>{{user.city}},</span>
              </template>
              <span>{{user.country}}</span>
              <iron-icon 
                class="edit" 
                icon="create"
                disabled$="{{_disableEditLocation}}"
                on-click="_editLocation"
              ></iron-icon>
            </template>
            <template is="dom-if" if="{{_isEditingLocation}}">
              <paper-input 
                auto-validate 
                name="city" id="inputCity" label="City" 
                type="text" value="{{_city}}"  
                required maxlength="64" 
                invalid={{_invalidCity}}></paper-input>
              <paper-input 
                auto-validate 
                name="country" id="inputCountry" label="Country" 
                type="text" value="{{_country}}"  
                required maxlength="64" 
                invalid={{_invalidCountry}}></paper-input>
              <iron-icon 
                class="submit" disabled$="{{_invalidLocation}}"
                icon="done" on-click="_submitLocation" ></iron-icon>    
              <iron-icon 
                class="close"
                icon="clear" on-click="_closeEditLocation" ></iron-icon>
            </template>
          </div>
          <div
            class = "line">
          </div>
          <h2>Skills</h2>
          <template 
            is    = "dom-repeat" 
            items = "{{user.skills}}">
            <p>{{item}}</p>
          </template>
          <div
            class = "line">
          </div>
          <h2>Biography</h2>
          <p class="biography">{{user.biography}}</p>
        </user-info>
      </paper-material>
    </paper-header-panel>
  </template>
<!--
    ====================================
                    JS
    ====================================
-->
  <script>
    Polymer({
      is: 'gtt-profile',
      properties : {
        user : {
          type: Object,
          observer: "_userChanged",  
          value: null,         
        },
        _userTitle: {
          type      : String,
          computed  : "_getUserTitle(user)"
        },
        _isEditingLocation: {
          type: Boolean,
          value: false
        },

      },

      /*
      * Location edit functions 
      */
      _editLocation: function() {
        this._city = this.user.city;
        this._country = this.user.country;     
        this._isEditingLocation = true;
      },
      _closeEditLocation: function() {
        this._isEditingLocation = false;
      },
      _submitLocation: function() {
        var userToUpdate = JSON.parse(JSON.stringify(this.user));
        userToUpdate.city = this._city;
        userToUpdate.country = this._country;

        delete userToUpdate.token;
        console.debug("[gtt-profile] _submitLocation", userToUpdate)
        var request = this.$$("expertstracking-account-insert");
        request.accessToken = this.user.token;
        request.body = userToUpdate;
        console.debug("[gtt-profile] _submitLocation", request)
        request.go();     
      },




      _getUserTitle: function() {
        var title = "";
        if (!this.user.product_group) {
          return "GDE";
        }
        if (this.user.product_group.length === 1) {
          title = this.user.product_group[0];
        } else if (this.user.product_group.length === 2) {
            //joins all with "&" but no commas
            title = this.user.product_group.join(' & ');
        } else if (this.user.product_group.length > 2) {
            //joins all with commas, but last one gets " & "
            title = this.user.product_group.slice(0, -1).join(', ') + ' & ' + this.user.product_group.slice(-1);
        }
        return title + ' GDE';
      },

      _userChanged: function(){
        console.debug("[gtt-activity-list] _userChanged ", this.user);
        if (!this.user || !this.user.email) {
          this._apiUser = {};
          return;
        }
      },

      _handleAccountGet: function() {

        if (this._apiUser && this._apiUser.type) {
          this.set('user.category', this._apiUser.type);
          this.set('user.isExpert', (this._apiUser.type !== 'deleted'));
          this.set('user.skills', this._apiUser.skills);
          this.set('user.biography', this._apiUser.biography);
          this.set('user.city', this._apiUser.city);
          this.set('user.country', this._apiUser.country);
          this.set('user.image', this._apiUser.pic_url);
          this.set('user.product_group', this._apiUser.product_group);
        }
        console.debug("[gtt-profile] _handleAccountGet", this.user);
      },
    });
  </script>
</dom-module>
