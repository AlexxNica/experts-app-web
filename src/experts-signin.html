<link rel="import" href="../bower_components/iron-signals/iron-signals.html">

<link rel="import" href="../bower_components/google-signin/google-signin.html">

<!--
  Sign-in component hooked up to the Google Experts Tracking Backend
  to retrieve relevant user information like access rights.

  Exposes a `user` property that can be used to enable/disable
  features in the app via data-binding
-->

<dom-module id="experts-signin">
  <template>
    <google-signin
      client-id="66416776373-3k5goi8hn9d5rih68t8km57iliithohb.apps.googleusercontent.com"
      is-authorized="{{_isAuthorized}}"
      scope="email profile"  brand="google" theme="dark"
      on-google-signin-aware-success="_signedIn"
      label-signin="SIGN IN WITH GOOGLE"
      on-google-signed-out="_signedOut"></google-signin>

  </template>

  <script>
    (function() {
      Polymer({
        is: 'experts-signin',
        properties: {
          /**
           * All relevant information about the authenticated user
           */
          user: {
            type: Object,
            notify: true,
            readOnly: true
          },

          /**
           * User is authorized and all data has been retrieved
           */
          isAuthorized: {
            type: Boolean,
            readOnly: true,
            notify: true,
            value: false,
            computed: '_computeAuthorized(user)'
          },

          /**
           * User information from Google authentication
           */
          _googleUser: {
            type: Object,
            observer: '_userInfoChanged'
          },

          /**
           * User information from local storage
           */
          _localUser: Object,

          /**
           * User has granted Google authorization
           */
          _isAuthorized: {
            type: Boolean,
            // value: false
            observer: "_isAuthorizedChanged"
          }
        },

        /**
         * User signed in, retrieve user information from Google authentication
         */
        _signedIn: function () {
          var profile = gapi.auth2.getAuthInstance()
                          .currentUser.get().getBasicProfile();

          var authResponse = gapi.auth2.getAuthInstance()
                            .currentUser.get().getAuthResponse();

          this._googleUser = {
            id: profile.getEmail(),
            name: profile.getName(),
            image: profile.getImageUrl(),
            email: profile.getEmail(),
            token: authResponse.access_token || authResponse.id_token
          };
          // this._isAuthorized = true;

          console.debug("[experts-signin] _signedIn",this._googleUser);

          this.fire('iron-signal', {name: 'user', data: this._googleUser} )
        },

        /**
         * User signed out, remove all user information
         */
        _signedOut: function () {
          this._googleUser = undefined;
          this._apiUser = undefined;;
          // this._isAuthorized = false;
          this.fire('iron-signal', {name: 'user', data: false} )
        },


        _isAuthorizedChanged: function() {
          console.debug("[experts-signin] _isAuthorizedChanged", this._isAuthorized);
        },

        /**
         * Basic user information and access rights for the user
         */
        _userInfoChanged: function () {
          if (!this._googleUser || !this._googleUser.email) {
            this._setUser(undefined);
            return;
          }

          var user = {
            id: this._googleUser.id,
            name: this._googleUser.name,
            image: this._googleUser.image,
            email: this._googleUser.email,
            token: this._googleUser.token,
            isGoogler: (this._googleUser.email.split('@')[1] === 'google.com')
          };


          console.debug("[experts-sign-in] _userInfoChanged", user);
          this._setUser(user);
        },

        /**
         * Check if user data is initialized correctly
         */
        _computeAuthorized: function (user) {
          return (!!user && !!user.email);
        }
      });
    })();
  </script>
</dom-module>
