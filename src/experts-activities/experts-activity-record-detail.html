<!--
  Google Developers Experts Tracking App
  Copyright (C) 2016  by the GDE Tracking App Team

  gdetracking.appspot.com/
  https://github.com/GoogleDeveloperExperts/experts-app-web

  This program is free software: you can redistribute it and/or modify
  it under the terms of the GNU General Public License as published by
  the Free Software Foundation, either version 3 of the License, or
  (at your option) any later version.

  This program is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  GNU General Public License for more details.

  You should have received a copy of the GNU General Public License
  along with this program.  If not, see <http://www.gnu.org/licenses/>
-->
<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-pages/iron-pages.html">

<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-dialog-behavior/paper-dialog-behavior.html">
<link rel="import" href="../../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../../bower_components/paper-styles/color.html">

<link rel="import" href="experts-activity-post-list.html">
<link rel="import" href="experts-create-activity-post.html">
<!--
    ====================================
                  Shady DOM
    ====================================
-->
<dom-module 
  id = "experts-activity-record-detail">
  <template>
    
<!--
    ====================================
                     CSS 
    ====================================
-->
    <style>
      :host {
        display           : block;
        position          : fixed;
        top               : 10vh;
        left              : 10vw;
        width             : 80vw;
        overflow          : auto;
        border-radius     : 2px;    
        background: white;
        transition        : box-shadow 0.5s cubic-bezier(.25,.8,.25,1);
        box-shadow        : 0 14px 28px rgba(0,0,0,0.25), 0 10px 10px rgba(0,0,0,0.22);
        padding           : 0 25px;
      }
     :host:hover {
        box-shadow        : 0 19px 38px rgba(0,0,0,0.30), 0 15px 12px rgba(0,0,0,0.22);
      }
      :host > * {
        padding           : 0 !important;
      }
      #closeActivityDetail {
        position          : absolute;
        justify-content   : flex-end;
        right             : 16px;
        top               : 16px;
        margin            : 0;
        transition        : color 0.5s cubic-bezier(.25,.8,.25,1);
        color             : #e5e5e5;
      }
      #closeActivityDetail:hover {
        color             : #aaa;
      }
      #addActivityPost {
        position          : absolute;
        right             : 0;
        top               : -30px;
        background-color  : var(--google-green-500);
        transition        : box-shadow 0.3s cubic-bezier(.25,.8,.25,1);
        box-shadow        : 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);        
      }
      #addActivityPost:hover {
        box-shadow        : 0 3px 6px rgba(0,0,0,0.16), 0 3px 6px rgba(0,0,0,0.23);
      }       
      .item_list {
        @apply(--layout-horizontal);
        @apply(--layout-center);
        @apply(--layout-wrap);
      }
      .item_list .item:not(:first-child)  {
        margin-left        : 15px;
      }
      .item_list .item:not(:last-child)  {
        margin-right       : 15px;
      }

      paper-button {
        margin            : 5px;
        font-weight       : normal !important;
        cursor            : pointer;
      }
      .product_groups paper-button[active] {
        background-color  : #ff9e07;
        color             : #fff;
        margin            : 5px;
      }

      .groups paper-button[active] {
        background-color: #34a853;
        color: #fff;
        margin: 5px;
      } 
      .types paper-button.selected {
        background-color: #ff9e07;
        color: #fff;
        margin: 5px;
      }   
      .item { 
        margin-top        : 15px; 
        margin-bottom     : 15px; 
      } 

      .item_name { 
        color             : var(--paper-grey-600); 
        font-family       : 'Roboto', 'Noto', sans-serif;
        white-space       : nowrap; 
        overflow          : hidden; 
        text-overflow     : ellipsis; 
        font-size         : 12px; 
        font-weight       : 400; 
        letter-spacing    : 0.011em; 
        line-height       : 20px; 
      } 

      .item_value { 
        @apply(--layout-horizontal); 
        @apply(--layout-center); 
        @apply(--layout-wrap); 
      } 

      iron-icon.edit {
        cursor             : pointer;
        color              : var(--google-blue-500);
      }    
      iron-icon.submit,
      iron-icon.add {
        cursor             : pointer;
        color              : var(--google-green-500);
      }  
      iron-icon.delete {
      }
      iron-icon.close {
        cursor             : pointer;
        color              : var(--google-red-500);
      }

      iron-icon[disabled] {
        color: var(--google-grey-500) !important;
      }


      .edit_label {
        cursor             : pointer;
        padding            : 5px;
        border-radius      : 5px;
        color              : white;
        background-color   :  var(--google-blue-500);
      }
      .item_list .edit_label:not(:first-child)  {
        margin-left        : 15px;
      }
      .item_list .edit_label:not(:last-child)  {
        margin-right       : 15px;
      }   
      .container {
        position           : relative;
      }  
      .item_value.submit { 
        @apply(--layout-center-justified); 
      }       
      #submit[disabled] {
        background-color   : var(--paper-grey-500);
      }
      #submit { 
        background-color   : var(--google-blue-500);
        color              : white;
        margin             : 5px;
      } 
    </style>
<!--  
    ====================================
                   HTML
    ====================================
-->
      <paper-button
        id     = "closeActivityDetail"
        on-tap = "cancel"
        autofocus>
        <iron-icon 
          icon = "close">
        </iron-icon>
      </paper-button>


      <template 
         is = "dom-if" 
         if = "{{!_editActivity}}">

        <div 
          class = "item_list">
          <div 
            class = "item">
            <div 
              class = "item_value">
              <h2 
                class = "activityTitle">
                {{activity.title}}
              </h2>
            </div>
          </div>
          <paper-button
            id     = "editActivity"
            on-tap = "_doEditActivity">
            <iron-icon 
              icon  = "create" 
              class = "edit"></iron-icon>
          </paper-button>
        </div>

        <div 
          class = "item">
          <div 
            class = "item_name">
            Description
          </div>
          <div 
            class = "item_value activityDescription">
            {{activity.description}}
          </div>
        </div>   

        <div 
          class = "item_list">
          <div 
            class = "item">
            <div 
              class = "item_name">
              Type
            </div>
            <div 
              class = "item_value activityType">
              {{activity.activity_type}}
            </div>
          </div> 
          <div 
            class = "item">
            <div 
              class = "item_name">
              Products
            </div>
            <div 
              class = "item_value activityProductGroups">
              {{_serializeList(activity.product_groups)}}
            </div>
          </div>
        </div> 

        <div 
          class = "item_list">
          <div 
            class = "item">
            <div 
              class = "item_name">
              Date
            </div>
            <div 
              class = "item_value activityDate">
              {{activity.date}}
            </div>
          </div>  
          <div 
            class = "item">
            <div 
              class = "item_name">
              City
            </div>
            <div 
              class = "item_value activityCity">
              {{activity.city}}
            </div>
          </div>  
          <div 
            class = "item">
            <div 
              class = "item_name">
              Country
            </div>
            <div 
              class = "item_value activityCountry">
              {{activity.country}}
            </div>
          </div>  
        </div>

        <div 
          class = "item_list">
          <div 
            class = "item">
            <div 
              class = "item_name">
              Direct reach
            </div>
            <div 
              class = "item_value activityMetric">
              {{activity.metric_reached}}
            </div>
          </div>         
          <div 
            class = "item">
            <div 
              class = "item_name">
              Indirect reach
            </div>
            <div 
              class = "item_value activityMetric">
              {{activity.metric_indirect}}
            </div>
          </div>  
          <div 
            class = "item">
            <div 
              class = "item_name">
              Trained reach
            </div>
            <div 
              class = "item_value activityMetric">
              {{activity.metric_trained}}
            </div>
          </div>  
        </div>
      </template>

      <template 
        is = "dom-if" 
        if = "{{_editActivity}}">
        <div 
          class = "item_list">
          <paper-input 
            name      = "title" 
            id        = "inputTitle" 
            label     = "Title" 
            type      = "text" 
            value     = "{{activity.title}}"
            maxlength = "128"
            auto-validate 
            required >
          </paper-input>
        </div>

        <div 
          class = "item">
          <paper-textarea 
            name  = "description"
            id    = "inputDescription"
            label = "Description" 
            type  = "text" 
            value = "{{activity.description}}"
            auto-validate 
            required>
          </paper-textarea>
        </div>   


        <div class="item"> 
          <div class="item_name">Activity groups</div>
          <div class="groups item_value">
            <template  
                is="dom-repeat" 
                items="[[activityGroups]]">
              <paper-button 
                  on-tap="_selectActivityGroup" 
                  class="group" 
                  id="{{item.id}}" 
                  name="{{item.tag}}" 
                  active="{{item.active}}" 
                  toggles 
                  raised> 
                {{item.tag}} 
              </paper-button> 
            </template> 
          </div> 
        </div> 
        <template
            is  = "dom-if"
            if  = "{{_activityTypesActive}}">
          <div class="item"> 
            <div class="item_name">Activity type (only one allowed)</div>
            <div 
                class="types item_value"
                invalid$="{{_typeInvalid}}">
              <template 
                is="dom-repeat" 
                items="[[_activityTypes]]"
                as="type">
                <paper-button 
                    on-tap="_selectActivityType" 
                    class$="type {{type.selected}} yeah"
                    id="{{type.tag}}" 
                    name="{{type.tag}}" 
                    raised> 
                  {{type.tag}} 
                </paper-button> 
              </template> 
            </div>  
          </div> 
        </template>   

        <div 
          class = "item">
          <div 
            class = "item_name">
            Products
          </div>
          <div 
            class = "item_list activityProductGroups">
            <template 
              is    = "dom-repeat" 
              items = "{{activity.product_groups}}" 
              as    = "productGroup">
              <div 
                class = "edit_label" 
                on-tap = "_deleteProductGroup" >
                <iron-icon 
                  class = "delete"
                  icon = "cancel" >
                </iron-icon>
                {{productGroup}}
              </div>
            </template>
            <template 
              is = "dom-if" 
              if = "{{!_isAddingProductGroup}}">
              <iron-icon 
                class  = "add" 
                icon   = "add-circle" 
                on-tap = "_addProductGroup" >
              </iron-icon> 
            </template>
          </div>
        
          <template 
            is = "dom-if" 
            if = "{{_isAddingProductGroup}}">
            <div 
              class = "item_value">   
              <paper-input
                name      = "newProductGroup" 
                id        = "newProductGroup" 
                label     = "Activity ProductGroup"
                type      = "text" 
                value     = "{{_newProductGroup}}"
                maxlength = "64"
                invalid   = {{_invalidNewProductGroup}}
                required >
              </paper-input>
              <iron-icon
                class     = "submit" 
                disabled$ = "{{_invalidNewProductGroup}}"
                icon      = "done" 
                on-tap    = "_submitNewProductGroup" >
              </iron-icon>
              <iron-icon
                class  = "close"
                icon   = "clear" 
                on-tap = "_closeAddProductGroup" >
              </iron-icon>    
            </div>
          </template>
        </div>         

        <div 
          class = "item_list">
          <div 
            class = "item">
            <div 
              class = "item_name">
              Date
            </div>
            <div 
              class = "item_value activityDate">
              {{activity.date}}
            </div>
          </div>  
          <div 
            class = "item">
            <div 
              class = "item_name">
              City
            </div>
            <div 
              class = "item_value activityCity">
              {{activity.city}}
            </div>
          </div>  
          <div 
            class = "item">
            <div 
              class = "item_name">
              Country
            </div>
            <div 
              class = "item_value activityCountry">
              {{activity.country}}
            </div>
          </div>  
        </div>

        <div 
          class = "item_list">
          <div 
            class = "item">
            <div 
              class = "item_name">
              Direct reach
            </div>
            <div 
              class = "item_value activityMetric">
              {{activity.metric_reached}}
            </div>
          </div>         
          <div 
            class = "item">
            <div 
              class = "item_name">
              Indirect reach
            </div>
            <div 
              class = "item_value activityMetric">
              {{activity.metric_indirect}}
            </div>
          </div>  
          <div 
            class = "item">
            <div 
              class = "item_name">
              Trained reach
            </div>
            <div 
              class = "item_value activityMetric">
              {{activity.metric_trained}}
            </div>
          </div>  
        </div>
      </template>

      <div 
        class = "container">
        
        <paper-fab
          id          = "addActivityPost" 
          icon        = "add"
          on-tap      = "_openCreatePostDialog">
        </paper-fab>  

        <div 
          class = "item">
          <div 
            class = "item_name">
            Activity posts
          </div>
        </div>

        <experts-activity-post-list 
          user                     = "{{user}}"
          edit-mode                = "true"
          record-id                = "{{activity.id}}" 
          post-list                = "{{activity.listActivityPosts}}"
          on-edit-activity-post    = "_openEditPostDialog"
          on-delecte-activity-post = "_deleteActivityPost" >
        </experts-activity-post-list>

        <template 
          is = "dom-if" 
          if = "{{_editActivity}}">
          <div 
            class = "item"> 
            <div 
              class = "item_value submit">     
              <paper-button  
                id        = "submit" 
                on-tap    = "_submitUpdateActivityRecord"
                disabled$ ="{{_submitDisabled}}"
                raised > 
                Submit 
              </paper-button> 
            </div> 
          </div> 
        </template>
      </div>

      <experts-create-activity-post 
        id                       = "createActivityPost"
        user                     = "{{user}}"
        post                     = "{{_aPost}}"
        record-id                = "{{activity.id}}"
        activity-groups          = "{{activityGroups}}"
        product-groups           = "{{productGroups}}"
        on-activity-post-created = "_doAddActivityPost"        
        modal>
      </experts-create-activity-post>

      <iron-ajax
        id            = "updateActivityRecord"
        url           = "https://elite-firefly-737.appspot.com/_ah/api/expertstracking/v2.0/activityRecord"
        method        = "POST"
        content-type  = "application/json"
        handle-as     = "json"
        last-response = "{{_apiActivityRecord}}"
        on-response   = "_handleUpdateActivityRecord"></iron-ajax>

      <iron-ajax
        id            = "listActivityPost"
        url           = "https://elite-firefly-737.appspot.com/_ah/api/expertstracking/v2.0/activityPost/activityPost?activity_record={{activity.id}}"
        method        = "GET"
        content-type  = "application/json"
        handle-as     = "json"
        last-response = "{{_apiListActivityPost}}"
        on-response   = "_handleListActivityPost"></iron-ajax>        

      <iron-ajax
        id            = "deleteActivityPost"
        url           = "https://elite-firefly-737.appspot.com/_ah/api/expertstracking/v2.0/activityPost/delete/{{_deletePostId}}"
        method        = "DELETE"
        handle-as     = "json"
        last-response = "{{_apiActivityPostDelete}}"
        on-response   = "_handleActivityPostDelete"></iron-ajax>
  </template>
<!--
    ====================================
                    JS
    ====================================
-->
  <script>
    Polymer({ 
      is          : 'experts-activity-record-detail',
      properties  : {     
        activity        : {
          type            : Object,
          value           : null
        },
        productGroups   : {
          type            : Array,
          value           : function() {
            return [];
          }
        },        
        activityGroups  : {
          type            : 'array',
          notify          : true,
          value           : function(){ 
            return [];
          },
        }, 

        user            : {
          type            : Object,
          value: null
        },             

        _activityTypes  : {
          type            : Array,
          value           : function() {
            return [];
          }
        },  
        _editActivity   : {
          type            : Boolean,
          value           : false
        },
        _isAddingType   : {
          type            : Boolean,
          value           : false
        },
        _isAddingProductGroup: {
          type            : Boolean,
          value           : false
        },
        _activityTypesActive  : {
          type: Boolean,
          computed: "_isActivityTypesActive(_activityTypes)"
        },  
      },
      behaviors   : [
        Polymer.PaperDialogBehavior
      ],
      observers   : [
        "_paramsChanged(activity, activityGroups,  productGroups)"
      ],

      ready       : function() {
      /**
       * Attaching dialog to main body to make it live over the gray div 
       * Bug that will be corrected 
       * https://github.com/PolymerElements/polymer-starter-kit/issues/154
       * https://github.com/PolymerElements/paper-dialog/issues/7
       */
        this.createActivityPost = this.$.createActivityPost        
        document.querySelector('body').appendChild(this.createActivityPost);
      },

      _paramsChanged              : function() {
        console.debug("[experts-activity-record-detail] _paramsChanged", this.activity);
        if (!this.activity) {
          return;
        } 
        this._listActivityPosts(); 
      },

      _isActivityTypesActive  : function() {
       return (this._activityTypes.length > 0);
      },      
      _listActivityPosts          : function() {
        var request     = this.$.listActivityPost;
        request.headers = {
          Authorization : "Bearer "+ this.user.token
        }
        request.generateRequest();
      },
      _doEditActivity             : function() {
        this._editActivity = true;
      },
      _serializeList              : function(list, prefix) {
        prefix = prefix || "";
        var serializedList = ''
        for (var i in list) {
          serializedList += prefix + list[i];

          if (i < list.length-1) {
            serializedList += ', '
          }
        }
        return serializedList;
      },
      
      _selectActivityGroup     : function(e){

        console.debug("[experts-create-activity] _selectActivityGroup ", this.activityGroups);  
        var _activityTypes = [];
        if (!this.activity.activity_type) {
          this.activity.activity_type="";
        } else {
          var type = { 
            tag: this.activity.activity_type, 
            selected: "selected" 
          }; 
          _activityTypes.push(type); 
        }         
        for (var i in this.activityGroups) {
          if (this.activityGroups[i].active) {
            for (var j in this.activityGroups[i].types) {
              var already = false;
              for (var k in _activityTypes) {
                if (_activityTypes[k].tag == this.activityGroups[i].types[j]) {
                  already=true;
                  break;
                }
              }
              if (!already) {
                var type = { 
                  tag: this.activityGroups[i].types[j] 
                };
                _activityTypes.push(type);
              }  
            }
          }
        }
        this._activityTypes=_activityTypes.sort(function(a, b) {
          return +(a.tag > b.tag) || +(a.tag === b.tag) - 1;
        });
        console.debug("[experts-create-activity] _selectActivityGroup - _activityTypes", this._activityTypes);
      },

      _selectActivityType      : function(e){
        var tag = e.model.type.tag;

        console.debug("[experts-create] _selectActivityType", tag);
          
        for (var i in this._activityTypes) {
          if (this._activityTypes[i].tag == tag) {
            this.set(['_activityTypes',i,'selected'],"selected");  
          } 
          if (this._activityTypes[i].selected && this._activityTypes[i].tag != tag) {
            console.debug("Let's delete ", this._activityTypes[i])
            this.set(['_activityTypes',i,'selected'],""); 
          } 
        }  
        console.debug("[experts-create-activity] _activityTypes", this._activityTypes);
             
        this.set("activity.activity_type", tag);
        console.debug("[experts-create-activity] _selectActivityType - selected activity type", this.activity.activity_type);
      },

      _deleteProductGroup         : function(evt){
        console.debug("[experts-activity-record-detail] _deleteProductGroup", evt.model.productGroup);
        this.splice('activity.product_groups', evt.model.index, 1);
      },
      _addProductGroup            : function() {
        this._isAddingProductGroup = true;
      },
      _closeAddProductGroup       : function() {
        this._isAddingProductGroup = false;
      },
      _submitNewProductGroup      : function() {
        if (!this.activity.product_groups) {
          this.set('activity.product_groups', []);
        }
        this.push('activity.product_groups', this._newProductGroup);
        this._closeAddProductGroup();
      },
      _openCreatePostDialog       : function() {
        this._aPost = {};
        this.createActivityPost.open();
      },
      _openEditPostDialog         : function(evt, post) {
        this._aPost = post;
        this.createActivityPost.open();
      },
      _submitUpdateActivityRecord : function() {

        var request     = this.$.updateActivityRecord;
        request.body    = JSON.stringify(this.activity);

        request.headers = {
          Authorization : "Bearer "+ this.user.token
        }
        request.generateRequest();
      },
      _doAddActivityPost          : function(evt, post) {
        if (!this.activity.activity_posts) {
          this.set('activity.activity_posts', []);
        }
        this.push ('activity.activity_posts', post.id);
        this._submitUpdateActivityRecord();
      },
      _resynchroActivityPosts     : function() {
        if (!this.activity.listActivityPosts) {
          return;
        }
        var activity_posts = this.activity.listActivityPosts.map(function(post) {
          return post.id;
        });
        var synchroNeeded = false;

        var context = this;

        synchroNeeded = 
          !activity_posts.every(function(postId) {
            if (!context.activity.activity_posts) {
              return false;
            }
            return (context.activity.activity_posts.indexOf(postId) >= 0);
          }) ||
          !this.activity.activity_posts.every(function(postId) {
            return (activity_posts.indexOf(postId) >= 0);
          });

        if (synchroNeeded) {
          this.set('activity.activity_posts', activity_posts);
          console.debug("[experts-activity-record-detail] _resynchroActivityPosts - synchroNeeded", this.activity.activity_posts);
          this._submitUpdateActivityRecord();
        }  
      },
      _deleteActivityPost         : function(evt, postId) {
        console.debug("[experts-activity-record-detail] _deleteActivityPost", postId);
        this._deletePostId  = postId;
        var request         = this.$.deleteActivityPost;
        request.headers     = {
          Authorization : "Bearer "+ this.user.token
        }
        request.generateRequest();

        this._deletePostId  = "";

      },
      _handleUpdateActivityRecord : function() {
        this.activity       = this._apiActivityRecord;
        this._editActivity  = false;
      },
      _handleListActivityPost     : function() {
        this.set('activity.listActivityPosts', this._apiListActivityPost.items);
        console.debug("[experts-activity-record-detail] _handleListActivityPost", this.activity.listActivityPosts );
        this._resynchroActivityPosts()
      },
      _handleActivityPostDelete   : function() {
        console.debug("[experts-activity-record-detail] _handleActivityPostDelete", this._apiActivityPostDelete);
        if(this.activity.activity_posts && this.activity.activity_posts.indexOf(this._apiActivityPostDelete.id) >= 0) {
          this.splice('activity.activity_posts', this.activity.activity_posts.indexOf(this._apiActivityPostDelete.id), 1);
        }
        this._submitUpdateActivityRecord();
      },
    });
  </script>
</dom-module>        