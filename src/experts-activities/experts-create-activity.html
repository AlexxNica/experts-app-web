<!--
  Google Developers Experts Tracking App
  Copyright (C) 2016  by the GDE Tracking App Team

  gdetracking.appspot.com/
  https://github.com/GoogleDeveloperExperts/experts-app-web

  This program is free software: you can redistribute it and/or modify
  it under the terms of the GNU General Public License as published by
  the Free Software Foundation, either version 3 of the License, or
  (at your option) any later version.

  This program is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  GNU General Public License for more details.

  You should have received a copy of the GNU General Public License
  along with this program.  If not, see <http://www.gnu.org/licenses/>
-->
<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-pages/iron-pages.html">

<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-dialog-behavior/paper-dialog-behavior.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-styles/color.html">

<!--
   ====================================
                  Shady DOM
   ====================================
-->

<dom-module 
  id="experts-create-activity">
  <template>
    
<!--
   ====================================
                     CSS 
   ====================================
-->
    <style>
     :host {
        display         : block;
        position        : fixed;
        top             : 10vh;
        left            : 10vw;
        width           : 80vw;
        overflow        : auto;
        border-radius   : 2px;    
        background      : white;
        transition      : box-shadow 0.5s cubic-bezier(.25,.8,.25,1);
        box-shadow      : 0 14px 28px rgba(0,0,0,0.25), 0 10px 10px rgba(0,0,0,0.22);
        font-family     : Roboto;
        font-size       : 12px;
      }
      :host:hover {
        box-shadow      : 0 19px 38px rgba(0,0,0,0.30), 0 15px 12px rgba(0,0,0,0.22);
      }
      .content { 
        padding: 15px;  
      } 
      #closeCreateActivity {
        position        : absolute;
        justify-content : flex-end;
        right           : 16px;
        top             : 16px;
        margin          : 0;
        transition      : color 0.5s cubic-bezier(.25,.8,.25,1);
        color           : #e5e5e5;
      }
      #closeCreateActivity:hover {
        color           : #aaa;
      }
      #continue {
        margin          : 0 auto;
      }
      h2 {
        display         : flex;
        align-items     : center;
        color           : #4285f4;
        font-size       : 16px;
        font-weight     : 500;
        min-height      : 56px;
        margin          : 0 0 0 21px !important;
      }
      h2  iron-icon {
        margin-right    : 10px;
        color           : #e5e5e5;
        cursor          : pointer;
        transition      : color 0.5s cubic-bezier(.25,.8,.25,1);
      }
       h2  iron-icon:hover {
        color           : #aaa;
      }
      section#details {
        display         : flex;
        flex-wrap       : wrap;
      }
      paper-input {
        width           : 100%;
        --paper-input-container-input: {
          font-size       : 12px;
        };        
        --paper-input-container-label: {
          font-size       : 12px;
        };        
      }
      paper-button {
        font-size        : 12px;
        margin            : 5px;
        font-weight       : normal !important;
        cursor            : pointer;
      }
      .product_groups paper-button[active] {
        background-color  : #ff9e07;
        color             : #fff;
        margin            : 5px;
      }

      .groups paper-button[active] {
        background-color: #34a853;
        color: #fff;
        margin: 5px;
      } 
      .types paper-button.selected {
        background-color: #ff9e07;
        color: #fff;
        margin: 5px;
      }        
      .item { 
        margin-top        : 15px; 
        margin-bottom     : 15px; 
      } 

      .item_name { 
        color             : var(--paper-grey-600); 
        font-family       : 'Roboto', 'Noto', sans-serif;
        white-space       : nowrap; 
        overflow          : hidden; 
        text-overflow     : ellipsis; 
        font-size         : 12px; 
        font-weight       : 400; 
        letter-spacing    : 0.011em; 
        line-height       : 20px; 
      } 

      .item_value { 
        @apply(--layout-horizontal); 
        @apply(--layout-center); 
        @apply(--layout-wrap); 
      } 
      footer {
        display           : flex;
        flex-direction    : column;
        align-items       : center;
        justify-content   : center;
        height            : 100px;
      }
      footer  paper-button {
        color             : #fff;
        background-color  : #4285f4;
        border-radius     : 2px;
        padding           : 14px 30px;
        font-size         : 14px;
      }
      footer  .progress {
        display           : flex;
        flex-direction    : row;
        justify-content   : center;
        align-items       : center;
        height            : 48px;
      }
      footer  .progress  .indicator {
        border-radius     : 50%;
        width             : 8px;
        height            : 8px;
        margin            : 0 3px 0;
        background-color  : #d8d8d8;
      }
      footer  .progress  .indicator#first[active] {
        background-color  : #4285f4;
      }
      footer  .progress  .indicator#second[active] {
        background-color  : #ea4335;
      }
      footer  .progress  .indicator#third[active] {
        background-color  : #fbbc05;
      }
      footer  .progress  .indicator#fourth[active] {
        background-color  : #34a853;
      }      
      
    </style>
<!--  
   ====================================
                   HTML
   ====================================
-->
    
    <paper-button
        id      = "closeCreateActivity"
        on-tap  = "cancel"
        autofocus>
      <iron-icon 
          icon  = "close">
      </iron-icon>
    </paper-button>

    <div class='content'> 
      <iron-pages 
          id        = "ironpages" 
          selected  = "{{_currentStep}}">
        <!-- Tab 0 -->
        <div>
          <h2>
            Add an activity
          </h2>
          <section>
            <div class="item"> 
              Fill in the details below to add and track your activity.
            </div>
            <div class="item"> 
              <paper-input
                  id    = "title"
                  type  = "text"
                  label = "Activity Title"
                  value = "{{ newActivity.title }}">
              </paper-input>
            </div>
            <div class="item"> 
              <paper-input
                  id    = "description"
                  type  = "text"
                  label = "Description"
                  value = "{{ newActivity.description }}">
              </paper-input>
            </div>
          </section>
        </div>  
        <!-- Tab 1 -->
        <div>
          <h2>
            <iron-icon 
                icon    = "arrow-back"
                on-tap  = "back">
            </iron-icon>
            Product Groups
          </h2>
          <section>
            <div class="item"> 
              <div class="item_name">
                Choose the product groups concerned by the activity
              </div>
              <div class="product_groups item_value">
                <template 
                    is    = "dom-repeat" 
                    items = "[[productGroups]]"
                    as="product">
                  <paper-button
                      id      = "{{product.id}}"
                      class   = "productGroup"
                      on-tap  = "_selectProductGroup"
                      active  = "{{product.active}}"
                      toggles
                      raised>
                    {{product.tag}}
                  </paper-button>
                </template>   
              </div>
          </section>
        </div>
        <!-- Tab 2 -->
        <div>
          <h2>
            <iron-icon 
                icon    = "arrow-back"
                on-tap  = "back">
            </iron-icon>
            Activity Type
          </h2>
          <section>
            <div class="item"> 
              <div class="item_name">Begin by choosing one or several relevant activity groups</div>
              <div class="groups item_value">
                <template  
                    is="dom-repeat" 
                    items="[[activityGroups]]">
                  <paper-button 
                      on-tap="_selectActivityGroup" 
                      class="group" 
                      id="{{item.id}}" 
                      name="{{item.tag}}" 
                      active="{{item.active}}" 
                      toggles 
                      raised> 
                    {{item.tag}} 
                  </paper-button> 
                </template> 
              </div> 
            </div> 
            <template
                is  = "dom-if"
                if  = "{{_activityTypesActive}}">
              <div class="item"> 
                <div class="item_name">Now choose the relevant activity type (only one allowed)</div>
                <div 
                    class="types item_value"
                    invalid$="{{_typeInvalid}}">
                  <template 
                    is="dom-repeat" 
                    items="[[_activityTypes]]"
                    as="type">
                    <paper-button 
                        on-tap="_selectActivityType" 
                        class$="type {{type.selected}} yeah"
                        id="{{type.tag}}" 
                        name="{{type.tag}}" 
                        raised> 
                      {{type.tag}} 
                    </paper-button> 
                  </template> 
                </div>  
              </div> 
            </template>
          </section>
        </div>
        
        <!-- Tab 3 -->
        <div>
          <h2>
            <iron-icon 
                icon    = "arrow-back" 
                on-tap  = "back">
            </iron-icon>
            Details
          </h2>
          <section
            id="details">
            <paper-input
                id    = "city"
                type  = "text"
                label = "Which city?"
                value = "{{ newActivity.city }}">
            </paper-input>
            <paper-input
                id    = "country"
                type  = "text"
                label = "Which country?"
                value = "{{ newActivity.country }}">
            </paper-input>
            <paper-input
                id    = "date"
                type  = "date"
                label = "When it happened?"
                value = "{{ newActivity.date }}">
            </paper-input>
          </section>
        </div>
      </iron-pages>  
    </div>
    <footer>
      <template 
          is  = "dom-if"
          if  = "{{!_lastStep}}">
        <paper-button 
            id        = "continue" 
            on-tap    = "next"
            disabled  = "{{_stepDisabled}}">
          Continue
        </paper-button>
      </template>
      <template 
          is  = "dom-if"
          if  = "{{_lastStep}}">        
        <paper-button 
            id        = "continue" 
            on-tap    = "finish"
            disabled  = "{{_stepDisabled}}">
          Finish
        </paper-button>
      </template>
      <div
          class = "progress">
        <div 
            id      = "first"
            class   = "indicator"
            active$ = "{{_isCurrentStep(0, _currentStep)}}">
        </div>
        <div
            id      = "second"
            class   = "indicator"
            active$ = "{{_isCurrentStep(1,_currentStep)}}">
        </div>
        <div
            id      = "third"
            class   = "indicator"
            active$ = "{{_isCurrentStep(2, _currentStep)}}">
        </div>
        <div
            id      = "fourth"
            class   = "indicator"
            active$ = "{{_isCurrentStep(3, _currentStep)}}">
        </div>
      </div>
    </footer>
  </template>
<!--
   ====================================
                    JS
   ====================================
-->
  <script>
    Polymer({ 
      is          : 'experts-create-activity',
      properties  : {
/**
 * The new activity
 */
        newActivity           : {
          type: Object,
          notify: true,
          value: function() {
            return {
              'title': '',
              'description': '',
              'activity_types': []
            };
          }
        },        
/**
 * The allowed activity groups 
 */  
        productGroups         : {
          type: Array,
          value: function() {
            return [];
          }
        },
        activityGroups        : {
          type: Array,
          notify: true,
          value: function(){ 
            return [];
          },
        },
        _activityTypes        : {
          type: Array,
          value: function() {
            return [];
          }
        },        
        _currentStep          : {
          type: Number,
          value: 0
        },
        _numberOfSteps        : {
          type: Number,
          value: 4
        },
        _lastStep             : {
          type: Boolean,
          computed: "_isLastStep(_currentStep,_numberOfSteps)"
        },
        _stepDisabled         : {
          type: Boolean,
          computed: "_isStepDisabled(_currentStep, newActivity.*)" 
        },
        _activityTypesActive  : {
          type: Boolean,
          computed: "_isActivityTypesActive(_activityTypes)"
        },    
      },
      behaviors               : [
        Polymer.PaperDialogBehavior
      ],
      back                    : function() {
        if (this._currentStep > 0) {
          this._currentStep -= 1;
        }
      },      
      next                    : function() {
        // console.debug("[experts-create-activity] next - current tab: ", this._currentStep );
        if (this._currentStep < this._numberOfSteps -1) {
          this._currentStep += 1;
        }
      },
      finish                  : function(){        
        this._currentStep=0;
        // console.debug("[experts-create-activity] finish - Activity: ",this.newActivity);
        this._finishNewActivity();
        this.close();
      },
      cancel                  : function(){        
        this._currentStep=0;
        this._initNewActivity();
        // console.debug("[experts-create-activity] close");
        this.close();
      },

      _selectActivityGroup     : function(e){

        console.debug("[experts-create-activity] _selectActivityGroup ", this.activityGroups);  
        var _activityTypes = [];
        if (!this.newActivity.activity_type) {
          this.newActivity.activity_type="";
        } else {
          var type = { 
            tag: this.newActivity.activity_type, 
            selected: "selected" 
          }; 
          _activityTypes.push(type); 
        }         
        for (var i in this.activityGroups) {
          if (this.activityGroups[i].active) {
            for (var j in this.activityGroups[i].types) {
              var already = false;
              for (var k in _activityTypes) {
                if (_activityTypes[k].tag == this.activityGroups[i].types[j]) {
                  already=true;
                  break;
                }
              }
              if (!already) {
                var type = { 
                  tag: this.activityGroups[i].types[j] 
                };
                _activityTypes.push(type);
              }  
            }
          }
        }
        this._activityTypes=_activityTypes.sort(function(a, b) {
          return +(a.tag > b.tag) || +(a.tag === b.tag) - 1;
        });
        console.debug("[experts-create-activity] _selectActivityGroup - _activityTypes", this._activityTypes);
      },

      _selectActivityType      : function(e){

        var tag = e.model.type.tag;

        console.debug("[experts-create] _selectActivityType", tag);
          
        for (var i in this._activityTypes) {
          if (this._activityTypes[i].tag == tag) {
            this.set(['_activityTypes',i,'selected'],"selected");  
          } 
          if (this._activityTypes[i].selected && this._activityTypes[i].tag != tag) {
            console.debug("Let's delete ", this._activityTypes[i])
            this.set(['_activityTypes',i,'selected'],""); 
          } 
        }  
        console.debug("[experts-create-activity] _activityTypes", this._activityTypes);
             
        this.set("newActivity.activity_type", tag);
        console.debug("[experts-create-activity] _selectActivityType - selected activity type", this.newActivity.activity_type);
      },

      _selectProductGroup      : function(e){

        var _selectedProductGroups = [];
        
        for (var i in this.productGroups) {
          if (this.productGroups[i].active) {
            _selectedProductGroups.push(this.productGroups[i].tag);
          }
        } 

        _selectedProductGroups  = _selectedProductGroups.sort(function(a, b) {
          return +(a.tag > b.tag) || +(a.tag === b.tag) - 1;
        });

        this.set("newActivity.product_groups", _selectedProductGroups);
        console.debug("[experts-create-activity] _selectProductGroup - selected product groups", this.newActivity.product_groups);
      },

      _isActivityTypesActive  : function() {
       return (this._activityTypes.length > 0);
      },
      _isLastStep             : function() {
       // console.debug("[experts-create-activity] _isLastStep - current tab: ", { current: this._currentStep, numberOfSteps: this._numberOfSteps, egality: this._currentStep == this._numberOfSteps -1 });
       return (this._currentStep == this._numberOfSteps -1);
      },
      _isCurrentStep          : function(step) {
        // console.debug("[experts-create-activity] _isCurrentStep: ", {current: this._currentStep, step: step} );
        return (this._currentStep == step);
      },   
      _createExpress          : function() {
        this.newActivity={"title":"Expert Tracking App","description":"Working in  this app","activity_types":["#experts","#opensourcecode"], "product_groups": [ "polymer" ],"city":"Brest","country":"France","date":"2016-07-31","url":"http://lostinbrittany.org","metric_reached":"42","metric_trained":"84","metric_indirect":"480"};
        this.finish();
      },
      _initNewActivity        : function() {
        this.newActivity={
          'title': '',
          'description': ''
        };
      },
      _finishNewActivity      : function() {
        console.debug("[experts-create-activity] _finishNewActivity ", this.newActivity);
        this.fire('activity-created', this.newActivity);
        this._initNewActivity();
      },
      _isStepDisabled         : function() {
        switch (this._currentStep) {
          case 0:
            return (!this.newActivity.title || !this.newActivity.description);
          case 1:
            return (!this.newActivity.product_groups || this.newActivity.product_groups.length==0 )
            break;
          case 2:
            return (!this.newActivity.activity_type)
            break;
          case 3:
            return (!this.newActivity.city || !this.newActivity.country || !this.newActivity.date);
          default:
            break;           
        }
      },    
    });
  </script>
</dom-module>
