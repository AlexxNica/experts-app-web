<!--
  Google Developers Experts Tracking App
  Copyright (C) 2016  by the GDE Tracking App Team

  gdetracking.appspot.com/
  https://github.com/GoogleDeveloperExperts/experts-app-web

  This program is free software: you can redistribute it and/or modify
  it under the terms of the GNU General Public License as published by
  the Free Software Foundation, either version 3 of the License, or
  (at your option) any later version.

  This program is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  GNU General Public License for more details.

  You should have received a copy of the GNU General Public License
  along with this program.  If not, see <http://www.gnu.org/licenses/>
-->
<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-pages/iron-pages.html">

<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-dialog-behavior/paper-dialog-behavior.html">
<link rel="import" href="../../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../../bower_components/paper-styles/color.html">

<link rel="import" href="experts-activity-detail-list.html">
<link rel="import" href="experts-activity-detail-create.html">
<!--
    ====================================
                  Shady DOM
    ====================================
-->
<dom-module 
  id = "experts-activity-edit">
  <template>
    
<!--
    ====================================
                     CSS 
    ====================================
-->
    <style>
      :host {
        display           : block;
        position          : fixed;
        top               : 10vh;
        left              : 10vw;
        width             : 80vw;
        overflow          : auto;
        border-radius     : 2px;    
        background: white;
        transition        : box-shadow 0.5s cubic-bezier(.25,.8,.25,1);
        box-shadow        : 0 14px 28px rgba(0,0,0,0.25), 0 10px 10px rgba(0,0,0,0.22);
        padding           : 0 25px;
      }
     :host:hover {
        box-shadow        : 0 19px 38px rgba(0,0,0,0.30), 0 15px 12px rgba(0,0,0,0.22);
      }
      :host > * {
        padding           : 0 !important;
      }
      #closeActivityDetail {
        position          : absolute;
        justify-content   : flex-end;
        right             : 16px;
        top               : 16px;
        margin            : 0;
        transition        : color 0.5s cubic-bezier(.25,.8,.25,1);
        color             : #e5e5e5;
      }
      #closeActivityDetail:hover {
        color             : #aaa;
      }
      #addActivityDetail {
        position          : absolute;
        right             : 0;
        top               : -30px;
        background-color  : var(--google-green-500);
        transition        : box-shadow 0.3s cubic-bezier(.25,.8,.25,1);
        box-shadow        : 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);        
      }
      #addActivityDetail:hover {
        box-shadow        : 0 3px 6px rgba(0,0,0,0.16), 0 3px 6px rgba(0,0,0,0.23);
      }   
      paper-input {
        width           : 100%;
        --paper-input-container-input: {
          font-size       : 12px;
        };        
        --paper-input-container-label: {
          font-size       : 12px;
        };        
      }

      paper-button {
      font-size       : 12px;
        margin            : 5px;
        font-weight       : normal !important;
        cursor            : pointer;
      }
      .product_groups paper-button[active] {
        background-color  : #ff9e07;
        color             : #fff;
        margin            : 5px;
      }

      .groups paper-button[active] {
        background-color: #34a853;
        color: #fff;
        margin: 5px;
      } 
      .types paper-button.selected {
        background-color: #ff9e07;
        color: #fff;
        margin: 5px;
      }   
      .item { 
        margin-top        : 15px; 
        margin-bottom     : 15px; 
      } 

      .item_name { 
        color             : var(--paper-grey-600); 
        font-family       : 'Roboto', 'Noto', sans-serif;
        white-space       : nowrap; 
        overflow          : hidden; 
        text-overflow     : ellipsis; 
        font-size         : 12px; 
        font-weight       : 400; 
        letter-spacing    : 0.011em; 
        line-height       : 20px; 
      } 

      .item_value { 
        @apply(--layout-horizontal); 
        @apply(--layout-center); 
        @apply(--layout-wrap); 
      } 
    
      .item_value iron-icon  {
        margin-left        : 15px;
      }
      
      .flexchild {
        @apply(--layout-flex);
      }

      .item_list {
        @apply(--layout-horizontal);
        @apply(--layout-center);
        @apply(--layout-wrap);
      }
      .item_list .item:not(:first-child)  {
        margin-left        : 15px;
      }
      .item_list .item:not(:last-child)  {
        margin-right       : 15px;
      }

      iron-icon.edit {
        cursor             : pointer;
        color              : var(--google-blue-500);
      }    
      iron-icon.submit,
      iron-icon.add {
        cursor             : pointer;
        color              : var(--google-green-500);
      }  
      iron-icon.delete {
      }
      iron-icon.close {
        cursor             : pointer;
        color              : var(--google-red-500);
      }

      iron-icon[disabled] {
        color: var(--google-grey-500) !important;
      }


      .edit_label {
        cursor             : pointer;
        padding            : 5px;
        border-radius      : 5px;
        color              : white;
        background-color   :  var(--google-blue-500);
      }
      .item_list .edit_label:not(:first-child)  {
        margin-left        : 15px;
      }
      .item_list .edit_label:not(:last-child)  {
        margin-right       : 15px;
      }   
      .container {
        position           : relative;
      }  
      .item_value.submit { 
        @apply(--layout-center-justified); 
      }       
      #submit[disabled] {
        background-color   : var(--paper-grey-500);
      }
      #submit { 
        background-color   : var(--google-blue-500);
        color              : white;
        margin             : 5px;
      } 
    </style>
<!--  
    ====================================
                   HTML
    ====================================
-->
      <paper-button
        id     = "closeActivityDetail"
        on-tap = "cancel"
        autofocus>
        <iron-icon 
          icon = "close">
        </iron-icon>
      </paper-button>

      <div class="item title">
        <template 
            is = "dom-if" 
            if = "{{!_isEditingTitle}}">
          <div class = "item_name">Title</div>
          <div class = "item_value">
            {{activity.title}}
            <iron-icon
                class="edit"
                icon="create"
                disabled$="{{_disableEdit}}"
                on-tap="_editTitle"
            ></iron-icon>
          </div>
        </template>
        <template 
            is = "dom-if" 
            if = "{{_isEditingTitle}}">
          <div class = "item_value">
            <paper-input 
                name      = "title" 
                id        = "inputTitle" 
                class     = "flexchild"
                label     = "Title" 
                type      = "text" 
                value     = "{{_title}}"
                maxlength = "128"
                auto-validate 
                required >
            </paper-input>
            <iron-icon
                class     = "submit" 
                icon      = "done" 
                on-tap    = "_submitEditTitle" ></iron-icon>
            <iron-icon
                class     = "close"
                icon      = "clear" 
                on-tap    = "_closeEditTitle" ></iron-icon>
          </div>
        </template>
      </div>

      <div class="item description">
        <template 
            is = "dom-if" 
            if = "{{!_isEditingDescription}}">
          <div class = "item_name">Description</div>
          <div class = "item_value">
            {{activity.description}}
            <iron-icon
                class="edit"
                icon="create"
                disabled$="{{_disableEdit}}"
                on-tap="_editDescription"
            ></iron-icon>
          </div>
        </template>
        <template 
            is = "dom-if" 
            if = "{{_isEditingDescription}}">
          <div class = "item_value">
            <paper-textarea 
                name      = "description"
                id        = "inputDescription"
                class     = "flexchild"
                label     = "Description" 
                type      = "text" 
                value     = "{{_description}}"
                auto-validate 
                required></paper-textarea>            
            <iron-icon
                class     = "submit" 
                icon      = "done" 
                on-tap    = "_submitEditDescription" ></iron-icon>
            <iron-icon
                class     = "close"
                icon      = "clear" 
                on-tap    = "_closeEditDescription" ></iron-icon>
          </div>
        </template>
      </div>


      <template 
          is = "dom-if" 
          if = "{{!_isEditingActivityType}}">
        <div class="item activity_type">
          <div class = "item_name">Activity Type</div>
          <div class = "item_value">
            {{activity.activity_type}}
            <iron-icon
                class="edit"
                icon="create"
                disabled$="{{_disableEdit}}"
                on-tap="_editActivityType"
            ></iron-icon>
          </div>
        </div>
      </template>
      <template 
          is = "dom-if" 
          if = "{{_isEditingActivityType}}">    
        <div class="item"> 
          <div class="item_name">Activity groups</div>
          <div class="groups item_value">
            <template  
                is="dom-repeat" 
                items="[[activityGroups]]">
              <paper-button 
                  on-tap="_selectActivityGroup" 
                  class="group" 
                  id="{{item.id}}" 
                  name="{{item.tag}}" 
                  active="{{item.active}}" 
                  toggles 
                  raised> 
                {{item.tag}} 
              </paper-button> 
            </template> 
          </div> 
        </div> 
        <template
            is  = "dom-if"
            if  = "{{_activityTypesActive}}">
          <div class="item"> 
            <div class="item_name">Activity type (only one allowed)</div>
            <div 
                class="types item_value"
                invalid$="{{_typeInvalid}}">
              <template 
                is="dom-repeat" 
                items="[[_activityTypes]]"
                as="type">
                <paper-button 
                    on-tap="_selectActivityType" 
                    class$="type {{type.selected}} yeah"
                    id="{{type.tag}}" 
                    name="{{type.tag}}" 
                    raised> 
                  {{type.tag}} 
                </paper-button> 
              </template> 
            </div>  
          </div> 
        </template>  
        <div class="item">
          <div class="item_value">   
            <template
                is  = "dom-if"
                if  = "{{_activityTypesActive}}">
                <iron-icon
                    class     = "submit" 
                    icon      = "done" 
                    on-tap    = "_submitEditActivityType" ></iron-icon>
            </template>
            <iron-icon
                class     = "close"
                icon      = "clear" 
                on-tap    = "_closeEditActivityType" ></iron-icon>
          </div>
        </div>
      </template>


      <template 
          is = "dom-if" 
          if = "{{!_isEditingProductGroups}}">
        <div class="item product_groups">
          <div class = "item_name">Product Groups</div>
          <div class = "item_value">
            {{ _serializeList(activity.product_groups) }}
            <iron-icon
                class="edit"
                icon="create"
                disabled$="{{_disableEdit}}"
                on-tap="_editProductGroups"
            ></iron-icon>
          </div>
        </div>
      </template>
      <template 
          is = "dom-if" 
          if = "{{_isEditingProductGroups}}">    
        <div class="item"> 
          <div class="item_name">Product Groups</div>
            <div class="product_groups item_value">
              <template 
                  is    = "dom-repeat" 
                  items = "[[productGroups]]"
                  as="product">
                <paper-button
                    id      = "{{product.id}}"
                    class   = "productGroup"
                    on-tap  = "_selectProductGroup"
                    active  = "{{product.active}}"
                    toggles
                    raised>
                  {{product.tag}}
                </paper-button>
              </template>   
            </div>
        </div> 
        <div class="item">
          <div class="item_value">   
            <iron-icon
                class     = "submit" 
                icon      = "done" 
                on-tap    = "_submitEditProductGroups" ></iron-icon>
            <iron-icon
                class     = "close"
                icon      = "clear" 
                on-tap    = "_closeEditProductGroups" ></iron-icon>
          </div>
        </div>
      </template>



      <template is="dom-if" if="{{!_isEditingLocation}}">
        <div class = "item_list">
          <div class = "item">
            <div class = "item_name">
              City
            </div>
            <div class = "item_value activityCity">
              {{activity.city}}
            </div>
          </div>  
          <div class = "item">
            <div class = "item_name">
              Country
            </div>
            <div class = "item_value activityCountry">
              {{activity.country}}
            </div>
          </div>  
          <iron-icon
              class="edit"
              icon="create"
              disabled$="{{_disableEdit}}"
              on-tap="_editLocation"></iron-icon>
        </div>
      </template>
      <template is="dom-if" if="{{_isEditingLocation}}">
        <paper-input
          auto-validate
          name="city" id="inputCity" label="City"
          type="text" value="{{_city}}"
          required maxlength="64"></paper-input>
        <paper-input
          auto-validate
          name="country" id="inputCountry" label="Country"
          type="text" value="{{_country}}"
          required maxlength="64"></paper-input>
        <iron-icon
          class="submit"
          icon="done" on-tap="_submitEditLocation" ></iron-icon>
        <iron-icon
          class="close"
          icon="clear" on-tap="_closeEditLocation" ></iron-icon>
      </template>



      <div class="item date">
        <template 
            is = "dom-if" 
            if = "{{!_isEditingDate}}">
          <div class = "item_name">Date</div>
          <div class = "item_value">
            {{activity.date}}
            <iron-icon
                class="edit"
                icon="create"
                disabled$="{{_disableEdit}}"
                on-tap="_editDate"
            ></iron-icon>
          </div>
        </template>
        <template 
            is = "dom-if" 
            if = "{{_isEditingDate}}">
          <div class = "item_value">
            <paper-input 
                name      = "date" 
                id        = "inputDate" 
                class     = "flexchild"
                label     = "Date" 
                type      = "date" 
                value     = "{{_date}}"
                maxlength = "128"
                auto-validate 
                required >
            </paper-input>
            <iron-icon
                class     = "submit" 
                icon      = "done" 
                on-tap    = "_submitEditDate" ></iron-icon>
            <iron-icon
                class     = "close"
                icon      = "clear" 
                on-tap    = "_closeEditDate" ></iron-icon>
          </div>
        </template>
      </div>

      <div 
        class = "item_list">
        <div 
          class = "item">
          <div 
            class = "item_name">
            Direct reach
          </div>
          <div 
            class = "item_value activityMetric">
            {{activity.metric_reached}}
          </div>
        </div>         
        <div 
          class = "item">
          <div 
            class = "item_name">
            Indirect reach
          </div>
          <div 
            class = "item_value activityMetric">
            {{activity.metric_indirect}}
          </div>
        </div>  
        <div 
          class = "item">
          <div 
            class = "item_name">
            Trained reach
          </div>
          <div 
            class = "item_value activityMetric">
            {{activity.metric_trained}}
          </div>
        </div>  
      </div>

      <div 
        class = "container">
        
        <paper-fab
            id          = "addActivityDetail" 
            icon        = "add"
            on-tap      = "_openCreateDetailDialog"></paper-fab>  

        <div 
          class = "item">
          <div 
              class = "item_name">
            Activity details
          </div>
        </div>

        <experts-activity-detail-list 
            user                     = "[[user]]"
            edit-mode                = "true"
            master-id                = "[[activity.id]]" 
            detail-list                = "[[activity.listActivityDetails]]"
            on-edit-activity-detail    = "_openEditDetailDialog"
            on-delecte-activity-detail = "_deleteActivityDetail" ></experts-activity-detail-list>

        <template 
          is = "dom-if" 
          if = "{{_editActivity}}">
          <div 
            class = "item"> 
            <div 
              class = "item_value submit">     
              <paper-button  
                id        = "submit" 
                on-tap    = "_submitUpdateActivityMaster"
                disabled$ ="{{_submitDisabled}}"
                raised > 
                Submit 
              </paper-button> 
            </div> 
          </div> 
        </template>
      </div>

      <experts-activity-detail-create 
          id                       = "createActivityDetail"
          user                     = "{{user}}"
          detail                     = "{{_aDetail}}"
          master-id                = "{{activity.id}}"
          activity-groups          = "{{activityGroups}}"
          product-groups           = "{{productGroups}}"
          on-activity-detail-created = "_doAddActivityDetail"        
          modal></experts-activity-detail-create>

      <iron-ajax
          id            = "updateActivityMaster"
          url           = "https://elite-firefly-737.appspot.com/_ah/api/expertstracking/v2.0/activityMaster"
          method        = "POST"
          content-type  = "application/json"
          handle-as     = "json"
          last-response = "{{_apiActivityMaster}}"
          on-response   = "_handleUpdateActivityMaster"></iron-ajax>

        <iron-ajax
          id            = "listActivityDetails"
          url           = "https://elite-firefly-737.appspot.com/_ah/api/expertstracking/v2.0/activityDetail/activityDetail?activity_master={{activity.id}}"
          method        = "GET"
          content-type  = "application/json"
          handle-as     = "json"
          last-response = "{{_apiListActivityDetails}}"
          on-response   = "_handleListActivityDetails"></iron-ajax>        

      <iron-ajax
        id            = "deleteActivityDetail"
        url           = "https://elite-firefly-737.appspot.com/_ah/api/expertstracking/v2.0/activityDetail/delete/{{_deleteDetailId}}"
        method        = "DELETE"
        handle-as     = "json"
        last-response = "{{_apiActivityDetailDelete}}"
        on-response   = "_handleActivityDetailDelete"></iron-ajax>
  </template>
<!--
    ====================================
                    JS
    ====================================
-->
  <script>
    Polymer({ 
      is          : 'experts-activity-edit',
      properties  : {     
        activity        : {
          type            : Object,
          notify          : true,
          value           : null
        },
        productGroups   : {
          type            : Array,
          value           : function() {
            return [];
          }
        },        
        activityGroups  : {
          type            : 'array',
          notify          : true,
          value           : function(){ 
            return [];
          },
        }, 

        user            : {
          type            : Object,
          value: null
        },             

        _activityTypes  : {
          type            : Array,
          value           : function() {
            return [];
          }
        },

        _isEditingTitle : {
          type            : Boolean,
          value           : false
        }, 
        _isEditingDescription   : {
          type            : Boolean,
          value           : false
        }, 
        _isEditingActivityType  : {
          type            : Boolean,
          value           : false
        }, 
        _isEditingProductGroups : {
          type            : Boolean,
          value           : false
        }, 
        _isEditingLocation : {
          type            : Boolean,
          value           : false
        }, 
        _isEditingDate : {
          type            : Boolean,
          value           : false
        }, 

        _editActivity   : {
          type            : Boolean,
          value           : false
        },
        _isAddingProductGroup: {
          type            : Boolean,
          value           : false
        },
        _activityTypesActive  : {
          type: Boolean,
          computed: "_isActivityTypesActive(_activityTypes)"
        },  
      },
      behaviors   : [
        Polymer.PaperDialogBehavior
      ],
      observers   : [
        "_paramsChanged(activity, activityGroups,  productGroups)"
      ],

      /************************************************************************/
      /* Lifecycle methods                                                    */
      /************************************************************************/
      ready       : function() {
      /**
       * Attaching dialog to main body to make it live over the gray div 
       * Bug that will be corrected 
       * https://github.com/PolymerElements/polymer-starter-kit/issues/154
       * https://github.com/PolymerElements/paper-dialog/issues/7
       */
        this.createActivityDetail = this.$.createActivityDetail        
        document.querySelector('body').appendChild(this.createActivityDetail);
      },


      /************************************************************************/
      /* Observers                                                            */
      /************************************************************************/
      _paramsChanged              : function() {
        console.debug("[experts-activity-edit] _paramsChanged", this.activity);
        if (!this.activity) {
          return;
        } 

        this._listActivityDetails(); 
      },


      /************************************************************************/
      /* Computed properties                                                  */
      /************************************************************************/
      _isActivityTypesActive  : function() {
          console.debug("[experts-activity-edit] _isActivityTypesActive", this._activityTypes);
        return (this._activityTypes.length > 0);
      },      


      /************************************************************************/
      /* Action listeners                                                     */
      /************************************************************************/
      _submitUpdateActivityMaster : function(evt) {

        var request     = this.$.updateActivityMaster;
        request.body    = JSON.stringify(this.activity);

        request.headers = {
          Authorization : "Bearer "+ this.user.token
        }
        request.generateRequest();
      },
   
      _selectActivityGroup : function(e){

        console.debug("[experts-activity-edit] _selectActivityGroup ", this.activityGroups);  
        var _activityTypes = [];
        if (!this.activity.activity_type) {
          this.activity.activity_type="";
        } else {
          var type = { 
            tag: this.activity.activity_type, 
            selected: "selected" 
          }; 
          _activityTypes.push(type); 
        }         
        for (var i in this.activityGroups) {
          if (this.activityGroups[i].active) {
            for (var j in this.activityGroups[i].types) {
              var already = false;
              for (var k in _activityTypes) {
                if (_activityTypes[k].tag == this.activityGroups[i].types[j]) {
                  already=true;
                  break;
                }
              }
              if (!already) {
                var type = { 
                  tag: this.activityGroups[i].types[j] 
                };
                _activityTypes.push(type);
              }  
            }
          }
        }
        this._activityTypes=_activityTypes.sort(function(a, b) {
          return +(a.tag > b.tag) || +(a.tag === b.tag) - 1;
        });
        console.debug("[experts-activity-edit] _selectActivityGroup - _activityTypes", this._activityTypes);
      },

      _selectActivityType : function(e){
        var tag = e.model.type.tag;

        console.debug("[experts-create] _selectActivityType", tag);
          
        for (var i in this._activityTypes) {
          if (this._activityTypes[i].tag == tag) {
            this.set(['_activityTypes',i,'selected'],"selected");  
          } 
          if (this._activityTypes[i].selected && this._activityTypes[i].tag != tag) {
            console.debug("Let's delete ", this._activityTypes[i])
            this.set(['_activityTypes',i,'selected'],""); 
          } 
        }  
        console.debug("[experts-activity-edit] _activityTypes", this._activityTypes);
             
        this._activity_type = tag;
        console.debug("[experts-activity-edit] _selectActivityType - selected activity type", this._activity_type);
      },


      _selectProductGroup      : function(e){
        var _selectedProductGroups = [];
        
        for (var i in this.productGroups) {
          if (this.productGroups[i].active) {
            _selectedProductGroups.push(this.productGroups[i].tag);
          }
        } 

        _selectedProductGroups  = _selectedProductGroups.sort(function(a, b) {
          return +(a.tag > b.tag) || +(a.tag === b.tag) - 1;
        });

        this._product_groups = _selectedProductGroups;
        console.debug("[experts-activity-edit] _selectProductGroup - selected product groups", this._product_groups);
      },

      _openCreateDetailDialog       : function() {
        this._aDetail = {};
        this.createActivityDetail.open();
      },
      _openEditDetailDialog         : function(evt, detail) {
        this._aDetail = detail;
        this.createActivityDetail.open();
      },
      _doAddActivityDetail          : function(evt, detail) {
        if (!this.activity.activity_details) {
          this.set('activity.activity_details', []);
        }
        this.push ('activity.activity_details', detail.id);
        this._submitUpdateActivityMaster();
      },      

      _deleteActivityDetail         : function(evt, detailId) {
        console.debug("[experts-activity-edit] _deleteActivityDetail", detailId);
        this._deleteDetailId  = detailId;
        var request         = this.$.deleteActivityDetail;
        request.headers     = {
          Authorization : "Bearer "+ this.user.token
        }
        request.generateRequest();

        this._deleteDetailId  = "";

      },

      _editTitle: function(evt) {
        this._title = this.activity.title;
        this._isEditingTitle = true;
      },
      _closeEditTitle: function(evt) {
        this._isEditingTitle = false;
      },
      _submitEditTitle: function(evt) {
        this.activity.title = this._title;
        this._submitUpdateActivityMaster();
        this._closeEditTitle();
      },
      _editDescription: function(evt) {
        this._description = this.activity._description;
        this._isEditingDescription = true;
      },
      _closeEditDescription: function(evt) {
        this._isEditingDescription = false;
      },   
      _submitEditDescription: function(evt) {
        this.activity.description = this._description;
        this._submitUpdateActivityMaster();
        this._closeEditDescription();
      },
      _editActivityType: function(evt) {
        this._activity_type = this.activity.activity_type;
        this._activityTypes =  [
          { 
            tag: this._activity_type, 
            selected: "selected" 
          } 
        ];
        this._isEditingActivityType = true;
      },
      _closeEditActivityType: function(evt) {
        this._isEditingActivityType = false;
      },   
      _submitEditActivityType: function(evt) {
        this.activity.activity_type = this._activity_type;
        this._submitUpdateActivityMaster();
        this._closeEditActivityType();
      },
      _editProductGroups: function(evt) {
        if (!this.activity.product_groups) {
          this.activity.product_groups = [];   
        } 
        this._product_groups = JSON.parse(JSON.stringify(this.activity.product_groups));
        var self = this;
        this.productGroups.forEach(function(product){
          if (self._product_groups.indexOf(product.tag) >= 0 ) {
            product.active = true;
          }
        });
        this._isEditingProductGroups = true;
      },
      _closeEditProductGroups: function(evt) {
        this._isEditingProductGroups = false;
      },   
      _submitEditProductGroups: function(evt) {
        this.activity.product_groups = JSON.parse(JSON.stringify(this._product_groups));
        this._submitUpdateActivityMaster();
        this._closeEditProductGroups();
      },
      _editLocation: function(evt) {
        this._city = this.activity.city;
        this._country = this.activity.country;
        this._isEditingLocation = true;
      },
      _closeEditLocation: function(evt) {
        this._isEditingLocation = false;
      },   
      _submitEditLocation: function(evt) {
        this.activity.city = this._city;
        this.activity.country = this._country;
        this._submitUpdateActivityMaster();
        this._closeEditLocation();
      },
      _editDate: function(evt) {
        this._date = this.activity.date;
        this._isEditingDate = true;
      },
      _closeEditDate: function(evt) {
        this._isEditingDate = false;
      },   
      _submitEditDate: function(evt) {
        this.activity.date = this._date;
        this._submitUpdateActivityMaster();
        this._closeEditDate();
      },



      /************************************************************************/
      /* Event listeners                                                      */
      /************************************************************************/
      _handleUpdateActivityMaster : function() {
        this.activity       = this._apiActivityMaster;
        this._editActivity  = false;
      },
      _handleListActivityDetails     : function() {
        console.debug("[experts-activity-edit] _handleListActivityDetails", this._apiListActivityDetails.items );
        this.set('activity.listActivityDetails', this._apiListActivityDetails.items);
        this._resynchroActivityDetails()
      },
      _handleActivityDetailDelete   : function() {
        console.debug("[experts-activity-edit] _handleActivityDetailDelete", this._apiActivityDetailDelete);
        this._listActivityDetails();
        this._resynchroActivityDetails();
      },


      /************************************************************************/
      /* Other methods                                                        */
      /************************************************************************/
      _listActivityDetails          : function() {
        var request     = this.$.listActivityDetails;
        request.headers = {
          Authorization : "Bearer "+ this.user.token
        }
        request.generateRequest();
      },


      _resynchroActivityDetails     : function() {
        if (!this.activity.listActivityDetails) {
          return;
        }
        var activity_details = this.activity.listActivityDetails.map(function(detail) {
          return detail.id;
        });
        var synchroNeeded = false;
        var context = this;
        synchroNeeded = 
          !activity_details.every(function(detailId) {
            if (!context.activity.activity_details) {
              return false;
            }
            return (context.activity.activity_details.indexOf(detailId) >= 0);
          }) ||
          !this.activity.activity_details.every(function(detailId) {
            return (activity_details.indexOf(detailId) >= 0);
          });
        if (synchroNeeded) {
          this.set('activity.activity_details', activity_details);
          console.debug("[experts-activity-record-detail] _resynchroActivityDetails - synchroNeeded", this.activity.activity_details);
          this._submitUpdateActivityMaster();
        }  
      },

      _serializeList: function(list) {
        var serializedList = ''
        for (var i in list) {
          serializedList += list[i];

          if (i < list.length-1) {
            serializedList += ', '
          }
        }
        return serializedList;
      },
    });
  </script>
</dom-module>        