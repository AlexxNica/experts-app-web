
<link rel="import" href="../bower_components/google-signin/google-signin.html">
<link rel="import" href="../bower_components/iron-localstorage/iron-localstorage.html">


<!--
  Sign-in component hooked up to the Google Experts Tracking Backend
  to retrieve relevant user information like access rights.

  Exposes a `user` property that can be used to enable/disable
  features in the app via data-binding
-->

<dom-module id="gtt-signin">
  <template>
    <!-- Prepare elements to access the API 
    <discovery-api-elements
      name="expertstracking"
      version="v2.0"
      app-id="elite-firefly-737"
      no-client
      ></discovery-api-elements>

    <!-- Fetch information about currently signed-in User 
    <expertstracking-account-get
      id="[[_googleUser.email]]"
      auto$="[[_isAuthorized]]"
      response="{{_apiUser}}"></gdetracking-account-get>      
      <!--  client-id="47242318878-dik3r14d8jc528h1ao35f8ehqa7tmpe1.apps.googleusercontent.com" 
      -->
    <google-signin
      client-id="854118353094-lnvlrs78qe1vlnrpd6nbgbaskteki0h4.apps.googleusercontent.com"
       
      scope="email profile"  brand="google" theme="dark"
      on-google-signin-aware-success="_signedIn"
      on-google-signed-out="_signedOut"></google-signin>

    <iron-localstorage
      id="currentUser"
      name="currentUser"
      value="{{_localUser}}"
      on-iron-localstorage-load="_localUserLoaded"
      on-iron-localstorage-load-empty="_initLocalUser"></iron-localstorage>
  </template>

  <script>
    (function() {
      Polymer({
        is: 'gtt-signin',
        properties: {
          /**
           * All relevant information about the authenticated user
           */
          user: {
            type: Object,
            notify: true,
            readOnly: true
          },

          /**
           * User is authorized and all data has been retrieved
           */
          isAuthorized: {
            type: Boolean,
            readOnly: true,
            notify: true,
            value: false,
            computed: '_computeAuthorized(user)'
          },

          /**
           * User information from Google authentication
           */
          _googleUser: {
            type: Object,
            observer: '_userInfoChanged'
          },

          /**
           * User information from the Experts Tracking App backend
           */
          _apiUser: {
            type: Object,
            observer: '_userInfoChanged'
          },

          /**
           * User information from local storage
           */
          _localUser: Object,

          /**
           * User has granted Google authorization
           */
          _isAuthorized: {
            type: Boolean,
            value: false
          }
        },

        /**
         * User signed in, retrieve user information from Google authentication
         */
        _signedIn: function () {
          var profile = gapi.auth2.getAuthInstance()
                          .currentUser.get().getBasicProfile();

          var authResponse = gapi.auth2.getAuthInstance()
                            .currentUser.get().getAuthResponse();

          this._googleUser = {
            id: profile.getId(),
            name: profile.getName(),
            image: profile.getImageUrl(),
            email: profile.getEmail(),
            token: authResponse.access_token || authResponse.id_token
          };
          this._isAuthorized = true;
          this._localUser = {
            id: profile.getId(),
            name: profile.getName(),
            image: profile.getImageUrl(),
            email: profile.getEmail(),
            token: authResponse.access_token || authResponse.id_token
          };
          console.debug("[gtt-signin] _signedIn",this._googleUser);
        },

        /**
         * User signed out, remove all user information
         */
        _signedOut: function () {
          this._googleUser = undefined;
          this._apiUser = undefined;
          this._localUser = {};
          this._isAuthorized = false;
        },

        /**
         * Initialize User in local storage
         */
        _initLocalUser: function () {
          this._localUser = {};
        },

        /**
         * User information available in local storage
         */
        _localUserLoaded: function () {
          if (this._localUser && this._localUser.id) {
            this._googleUser = {
              id: this._localUser.id,
              name: this._localUser.name,
              image: this._localUser.image,
              email: this._localUser.email,
              token: this._localUser.token
            };
            this._isAuthorized = true;
          }
        },

        /**
         * Basic user information and access rights for the user
         */
        _userInfoChanged: function () {
          if (!this._googleUser || !this._googleUser.id) {
            this._setUser(undefined);
            return;
          }

          var user = {
            id: this._googleUser.id,
            name: this._googleUser.name,
            image: this._googleUser.image,
            email: this._googleUser.email,
            token: this._googleUser.token,
            isGoogler: (this._googleUser.email.split('@')[1] === 'google.com')
          };

          if (this._apiUser && this._apiUser.type) {
            user.category = this._apiUser.type;
            user.isExpert = (this._apiUser.type !== 'deleted');
            user.skills = this._apiUser.skills;
            user.biography = this._apiUser.biography;
            user.city = this._apiUser.city;
            user.country = this._apiUser.country;
            user.avatar = this._apiUser.pic_url;
            user.product_group = this._apiUser.product_group;
          }

          console.debug("[gtt-sign-in] _userInfoChanged", user);
          this._setUser(user);
        },

        /**
         * Check if user data is initialized correctly
         */
        _computeAuthorized: function (user) {
          return (!!user && !!user.email);
        }
      });
    })();
  </script>
</dom-module>
